Ext.namespace("AuIt.Image","AuIt.Action.ImageEditor","AuIt.Action.ToolBar.ImageEditor");AuIt.Action.ImageEditor.SETSRC={actionGroup:"IMAGEEDITOR",itemId:"IMAGEEDITOR_SETSRC"};AuIt.Action.ImageEditor.RESET={disabled:false,actionGroup:"IMAGEEDITOR",itemId:"IMAGEEDITOR_RESET",tooltip:AuIt.locale.IE_RESET,iconCls:"auit-imagedit-reset",updateState:function(a){}};AuIt.Action.ImageEditor.REDO={disabled:true,actionGroup:"IMAGEEDITOR",itemId:"IMAGEEDITOR_REDO",tooltip:AuIt.locale.IE_REDO,iconCls:"edit-cmd-redo-16",updateState:function(a){if(a.source=="IMAGEEDITOR"){this.setDisabled(a.canvas.historyRedo.length<=0)}}};AuIt.Action.ImageEditor.UNDO={disabled:true,actionGroup:"IMAGEEDITOR",itemId:"IMAGEEDITOR_UNDO",iconCls:"edit-cmd-undo-16",tooltip:AuIt.locale.IE_UNDO,updateState:function(a){if(a.source=="IMAGEEDITOR"){this.setDisabled(a.canvas.historyUndo.length<=1)}}};AuIt.Action.ImageEditor.APPLY={disabled:true,text:AuIt.locale.IE_APPLY,actionGroup:"IMAGEEDITOR",itemId:"IMAGEEDITOR_APPLY",updateState:function(b){var a=true;if(b.source=="IMAGEEDITOR"){this.setDisabled(!b.canvas.isInResize()&&!b.canvas.isInCrop())}}};AuIt.Action.ImageEditor.CROP={actionGroup:"IMAGEEDITOR",disabled:false,enableToggle:true,pressed:false,itemId:"IMAGEEDITOR_CROP",iconCls:"auit-imagedit-crop",tooltip:AuIt.locale.IE_CROP,updateState:function(b){var a=true;if(b.source=="IMAGEEDITOR"){this.items.each(function(c){c.toggle(b.canvas.isInCrop())},this)}}};AuIt.Action.ImageEditor.RESIZE={actionGroup:"IMAGEEDITOR",disabled:false,enableToggle:true,pressed:false,itemId:"IMAGEEDITOR_RESIZE",iconCls:"auit-imagedit-resize",tooltip:AuIt.locale.IE_RESIZE,updateState:function(b){var a=true;if(b.source=="IMAGEEDITOR"){this.items.each(function(c){c.toggle(b.canvas.isInResize())},this)}}};AuIt.Action.ImageEditor.RESIZERESIZE={actionGroup:"IMAGEEDITOR",disabled:false,itemId:"IMAGEEDITOR_RESIZERESIZE",iconCls:"auit-imagedit-resizereset",tooltip:AuIt.locale.IE_RESIZERESIZE,updateState:function(a){if(a.source=="IMAGEEDITOR"){this.setDisabled(!a.canvas.isInResize())}}};AuIt.Action.ImageEditor.ROTATE={actionGroup:"IMAGEEDITOR",disabled:false,itemId:"IMAGEEDITOR_ROTATE",iconCls:"auit-imagedit-rotate",tooltip:AuIt.locale.IE_ROTATE,updateState:function(a){if(a.source=="IMAGEEDITOR"){this.setDisabled(a.canvas.isInResize()||a.canvas.isInCrop())}}};AuIt.Action.ImageEditor.FLIPHORZ={actionGroup:"IMAGEEDITOR",disabled:false,itemId:"IMAGEEDITOR_FLIPHORZ",iconCls:"auit-imagedit-flip-hor",tooltip:AuIt.locale.IE_FLIPHORZ,updateState:function(a){if(a.source=="IMAGEEDITOR"){this.setDisabled(a.canvas.isInResize()||a.canvas.isInCrop())}}};AuIt.Action.ImageEditor.FLIPVERT={actionGroup:"IMAGEEDITOR",disabled:false,itemId:"IMAGEEDITOR_FLIPVERT",iconCls:"auit-imagedit-flip-vert",tooltip:AuIt.locale.IE_FLIPVERT,updateState:function(a){if(a.source=="IMAGEEDITOR"){this.setDisabled(a.canvas.isInResize()||a.canvas.isInCrop())}}};AuIt.Action.ImageEditor.ZOOM={actionGroup:"IMAGEEDITOR",itemId:"IMAGEEDITOR_ZOOM",tooltip:AuIt.locale.IE_ZOOM,width:200,xtype:"slider",value:0,increment:10,minValue:10,maxValue:300,canvas:null,plugins:new Ext.ux.SliderTip({getText:function(a){return String.format("<b>{0}%</b>",a.getValue())}}),updateState:function(b){var a=true;if(b.source=="IMAGEEDITOR"){this.items.each(function(c){if(c.getValue()!=b.canvas.record.data.zoom){c.setValue(b.canvas.record.data.zoom*100)}},this)}},listeners:{change:function(a,c){var b=this.baseAction;b.value=c;b.executeCmd()}}};AuIt.Action.ToolBar.ImageEditor.MAIN=function(a){return new Ext.Toolbar({items:[a.getAction("RESET","ImageEditor"),"-",a.getAction("CROP","ImageEditor"),"-",a.getAction("RESIZE","ImageEditor"),a.getAction("RESIZERESIZE","ImageEditor"),"-",a.getAction("ROTATE","ImageEditor"),"-",a.getAction("FLIPHORZ","ImageEditor"),a.getAction("FLIPVERT","ImageEditor"),"->",a.getAction("UNDO","ImageEditor"),a.getAction("REDO","ImageEditor"),a.getAction("ZOOM","ImageEditor")]})};AuIt.Image.Resizable=Ext.extend(Ext.Resizable,{});AuIt.Image.Spinner=Ext.extend(Ext.ux.form.SpinnerField,{minValue:0,selectOnFocus:true,listeners:{spin:function(a){a.field.validate()}},validate:function(){var g=this.canvas.record.data;switch(this.name){case"crop_x":this.maxValue=g.image_width-g.crop_width;break;case"crop_y":this.maxValue=g.image_height-g.crop_height;break;case"crop_width":this.maxValue=g.image_width-g.crop_x;break;case"crop_height":this.maxValue=g.image_height-g.crop_y;break}var f=AuIt.Image.Spinner.superclass.validate.call(this);if(f){var b=this.getValue();var i=g[this.name];if(b!=i){if(this.name=="resize_width"&&g.preserve_ratio){var d=g.resize_height,e=d,a=g.resize_width,c=a;a=b;d=e*(a/c);a=c*(d/e);g.resize_width=Math.round(a);g.resize_height=Math.round(d);this.canvas.resizeForm.heightSpinner.setRawValue(g.resize_height)}else{if(this.name=="resize_height"&&g.preserve_ratio){var d=g.resize_height,e=d,a=g.resize_width,c=a;d=b;a=c*(d/e);d=e*(a/c);g.resize_width=Math.round(a);g.resize_height=Math.round(d);this.canvas.resizeForm.widthSpinner.setRawValue(g.resize_width)}else{g[this.name]=b}}this.canvas.updateResizable()}}return f}});AuIt.Image.FormCrop=Ext.extend(Ext.FormPanel,{bodyStyle:"border-width:0px;",baseCls:"x-plain",initComponent:function(){this.items=[{layout:"column",border:false,baseCls:"x-plain",defaults:{columnWidth:0.25,layout:"form",border:false,labelWidth:30,baseCls:"x-plain"},items:[{items:[new AuIt.Image.Spinner({fieldLabel:AuIt.locale.IE_X,name:"crop_x",anchor:"95%",canvas:this.canvas})]},{items:[new AuIt.Image.Spinner({fieldLabel:AuIt.locale.IE_Y,name:"crop_y",anchor:"95%",canvas:this.canvas})]},{labelWidth:50,items:[new AuIt.Image.Spinner({fieldLabel:AuIt.locale.IE_Width,name:"crop_width",anchor:"95%",canvas:this.canvas})]},{labelWidth:50,items:[new AuIt.Image.Spinner({fieldLabel:AuIt.locale.IE_Height,name:"crop_height",anchor:"95%",canvas:this.canvas})]}]}];AuIt.Image.FormCrop.superclass.initComponent.call(this)}});AuIt.Image.FormResize=Ext.extend(Ext.FormPanel,{bodyStyle:"border-width:0px;",baseCls:"x-plain",initComponent:function(){this.widthSpinner=new AuIt.Image.Spinner({fieldLabel:AuIt.locale.IE_Width,name:"resize_width",anchor:"95%",canvas:this.canvas});this.heightSpinner=new AuIt.Image.Spinner({fieldLabel:AuIt.locale.IE_Height,name:"resize_height",anchor:"95%",canvas:this.canvas});this.items=[{layout:"column",border:false,baseCls:"x-plain",defaults:{columnWidth:0.25,layout:"form",border:false,labelWidth:30,baseCls:"x-plain"},items:[{labelWidth:50,items:[this.widthSpinner]},{labelWidth:50,items:[this.heightSpinner]},{labelWidth:50,items:[new Ext.form.Checkbox({fieldLabel:AuIt.locale.IE_Ratio,name:"preserve_ratio",canvas:this.canvas,listeners:{check:function(b,a){this.canvas.record.data.preserve_ratio=a?1:0;this.canvas.updateResizable()}}})]}]}];AuIt.Image.FormResize.superclass.initComponent.call(this)}});AuIt.Image.Canvas=Ext.extend(Ext.Panel,{src:Ext.BLANK_IMAGE_URL,layout:"border",getMode:function(){return this.record.data.mode},isInCrop:function(){return this.getMode()=="CROP"},isInResize:function(){return this.getMode()=="RESIZE"},initComponent:function(){this.resetRecord();this.tbar=AuIt.App.getActionMgr().getToolBar("MAIN","ImageEditor");this.cropForm=new AuIt.Image.FormCrop({canvas:this});this.cropForm.hide();this.resizeForm=new AuIt.Image.FormResize({canvas:this});this.resizeForm.hide();this.toolbarPanel=new Ext.Panel({baseCls:"x-plain",region:"north",split:false,collapsible:false,height:35,bodyStyle:"padding:5px 5px 0;",frame:false,border:false,layout:"fit",items:[this.cropForm,this.resizeForm]});this.drawPane=new Ext.Panel({region:"center",autoScroll:true,style:"padding:5px",cls:"auit-img-editor-canvas",html:'<img src="'+this.src+'" />'});this.items=[this.toolbarPanel,this.drawPane];AuIt.Image.Canvas.superclass.initComponent.call(this)},resetRecord:function(){this.historyUndo=[];this.historyRedo=[];var a=Ext.data.Record.create([{name:"crop_x"},{name:"crop_y"},{name:"crop_width"},{name:"crop_height"},{name:"zoom"},{name:"preserve_ratio"},{name:"resize_width"},{name:"resize_height"},{name:"image_width"},{name:"image_height"},{name:"src"},{name:"rotate"},{name:"mode"},{name:"original_src"}]);this.record=new a({crop_x:10,crop_y:10,crop_width:100,crop_height:100,zoom:1,resize_width:0,resize_height:0,rotate:0,preserve_ratio:1,url:"",mode:"",original_src:""});this.toggleResize(false);this.toggleCrop(false)},onRender:function(){AuIt.Image.Canvas.superclass.onRender.apply(this,arguments)},onImageLoad:function(){AuIt.App.getActionMgr().updateState({source:"IMAGEEDITOR",canvas:this});var a=this.image.getBox();this.record.data.image_width=a.width;this.record.data.image_height=a.height;this.record.data.resize_width=a.width;this.record.data.resize_height=a.height;if(this.record.data.zoom!=1){this.image.setHeight((this.record.data.image_height*this.record.data.zoom))}if(this.resizableCrop){this.resizableCrop.dd.constrainTo(this.image);this.checkResizeBox()}if(this.resizeHelper){if(this.image.dom.src!=this.resizeHelper.dom.src){this.resizeHelper.dom.src=this.image.dom.src}}this.updateCoords();AuIt.App.getActionMgr().updateState({source:"IMAGEEDITOR",canvas:this})},setSrc:function(b,a){this.src=b;if(!this.record.data.original_src){this.record.data.original_src=b}if(this.drawPane.rendered){if(a!==true){this.historyUndo.unshift(b)}this.record.data.src=b;this.image=Ext.get(this.drawPane.body.dom.firstChild);this.image.on("load",this.onImageLoad,this,{single:true});this.image.dom.style.height=this.image.dom.style.width="auto";this.image.dom.src=b+"?d="+new Date().getTime();AuIt.App.getActionMgr().updateState({source:"IMAGEEDITOR",canvas:this})}},initEvents:function(){AuIt.Image.Canvas.superclass.initEvents.apply(this,arguments)},updateCoords:function(){if(this.ignoreChanged){return}this.cropRatio=1;var f=this.record;var c,a,j,i;var b=1/f.data.zoom;if(this.resizableCrop&&this.isInCrop()){var g=this.resizableCrop.el.getBox();var e=this.image.getBox();var m=f.data.image_width;var h=f.data.image_height;var l=e.x;var k=e.y;c=g.x-l;j=g.y-k;a=c+g.width;i=j+g.height;c=Math.round(c*b);j=Math.round(j*b);a=Math.round(a*b);i=Math.round(i*b);if(c<0){c=0}if(j<0){j=0}if((a-c)>m){a=m-c}if((i-j)>h){i=h-j}f.data.crop_x=c;f.data.crop_y=j;f.data.crop_width=(a-c);f.data.crop_height=(i-j);this.cropForm.getForm().loadRecord(f)}if(this.resizableResize&&this.isInResize()){var d=this.resizableResize.el.getBox();c=d.width;c=Math.round(c*b);a=d.height;a=Math.round(a*b);f.data.resize_width=c;f.data.resize_height=a;this.resizeForm.getForm().loadRecord(f)}},updateResizable:function(){var b=this.record;this.ignoreChanged=true;var a=b.data.zoom;if(this.resizableCrop&&this.isInCrop()){this.resizableCrop.el.setLeft(b.data.crop_x*a+"px");this.resizableCrop.el.setTop(b.data.crop_y*a+"px");this.resizableCrop.resizeTo(b.data.crop_width*a,b.data.crop_height*a)}if(this.resizableResize&&this.isInResize()){this.resizableResize.preserveRatio=b.data.preserve_ratio?true:false;this.resizableResize.resizeTo(b.data.resize_width*a,b.data.resize_height*a);if(this.image.dom.src!=this.resizeHelper.dom.src){this.resizeHelper.dom.src=this.image.dom.src}}this.ignoreChanged=false},resetResizable:function(){var b=this.record;this.ignoreChanged=true;var a=b.data.zoom;this.resizableResize.resizeTo(b.data.image_width*a,b.data.image_height*a);this.ignoreChanged=false},checkResizeBox:function(){var d=this.resizableCrop.el.getRegion();var a,c=this.image.getRegion();if(d.left<c.left){a=true;d.left=c.left}if(d.top<c.top){a=true;d.top=c.top}if(d.right>c.right){a=true;d.right=c.right}if(d.bottom>c.bottom){a=true;d.bottom=c.bottom}if(d.left>=d.right){a=true;d.left=c.left}if(d.top>=d.bottom){a=true;d.top=c.top}if(a){this.resizableCrop.el.setRegion(d)}},setZoom:function(b){var a=this.record.data.zoom;this.record.data.zoom=b/100;this.image.setHeight((this.record.data.image_height*this.record.data.zoom));if(this.resizableCrop){this.resizableCrop.dd.constrainTo(this.image);this.checkResizeBox()}this.updateCoords()},toggleResize:function(a){if(!this.drawPane){return}if(a!==false){this.record.data.mode=this.isInResize()?"":"RESIZE";a=this.isInResize()}if(a){this.toggleCrop(false)}if(a){if(!this.resizableResize){this.resizeHelper=Ext.get(Ext.DomHelper.append(this.drawPane.body,{tag:"img",style:"position:absolute;left:0px;top:0px;",src:Ext.BLANK_IMAGE_URL,height:10,width:10}));this.resizableResize=new AuIt.Image.Resizable(this.resizeHelper,{adjustments:[0,0],wrap:true,pinned:true,draggable:false,dynamic:true,minWidth:25,minHeight:25,handles:"e se s",preserveRatio:true});this.resizableResize.on("resize",function(c,d,b){this.updateCoords()},this)}this.resizableResize.el.show();this.updateResizable()}else{if(!a&&this.resizableResize){this.resizableResize.el.hide()}}this.showPanels();if(a!==false){this.updateCoords()}AuIt.App.getActionMgr().updateState({source:"IMAGEEDITOR",canvas:this})},toggleCrop:function(a){if(!this.drawPane){return}if(a!==false){this.record.data.mode=this.isInCrop()?"":"CROP";a=this.isInCrop()}if(a){this.toggleResize(false)}if(!this.cropHelper){this.cropHelper=Ext.get(Ext.DomHelper.append(this.drawPane.body,{tag:"img",style:"position:absolute;cursor: move;left:0px;top:0px;",src:Ext.BLANK_IMAGE_URL,height:100,width:100}))}if(a){if(!this.resizableCrop){this.resizableCrop=new AuIt.Image.Resizable(this.cropHelper,{wrap:true,pinned:true,draggable:true,dynamic:true,minWidth:25,minHeight:25,handles:"all",constrainTo:this.image});this.resizableCrop.on("resize",function(d,e,c){this.updateCoords()},this);var b=this;this.resizableCrop.dd.onDrag=function(){b.updateCoords()}}this.resizableCrop.el.show();this.updateResizable()}else{if(!a&&this.resizableCrop){this.resizableCrop.el.hide()}}this.showPanels();if(a!==false){this.updateCoords()}AuIt.App.getActionMgr().updateState({source:"IMAGEEDITOR",canvas:this})},showPanels:function(){if(this.cropForm){if(this.isInCrop()){this.cropForm.show()}else{this.cropForm.hide()}}if(this.resizeForm){if(this.isInResize()){this.resizeForm.show()}else{this.resizeForm.hide()}}if(this.toolbarPanel){this.toolbarPanel.doLayout()}}});AuIt.Image.Editor=Ext.extend(AuIt.ModalWindow,{title:"Imageeditor",closeAction:"hide",layout:"fit",onOK:function(){var a=AuIt.App.getActionMgr().getAction("APPLY","ImageEditor");this.closeOnEnd=true;a.executeCmd();return false},initComponent:function(){this.canvas=new AuIt.Image.Canvas({cfg:this.cfg});this.items=[this.canvas];this.buttons=[AuIt.App.getActionMgr().getAction("APPLY","ImageEditor")];return AuIt.Image.Editor.superclass.initComponent.call(this)},onShow:function(){AuIt.App.getActionMgr().on("cmd",this.onCmd,this);AuIt.App.getActionMgr().on("itemchanged",this.onItemChanged,this)},onHide:function(){AuIt.App.getActionMgr().un("cmd",this.onCmd,this);AuIt.App.getActionMgr().un("itemchanged",this.onItemChanged,this)},onItemChanged:function(a){if(a.source=="FILEBROWSER"&&a.node){}},onCmd:function(a){if(a.actionGroup!="IMAGEEDITOR"){return}switch(a.itemId){case"IMAGEEDITOR_SETSRC":if(a.resetRecord){this.canvas.resetRecord();a.resetRecord=false}a.actionMgr.request(a,{directCall:true,url:AUIT_EDITOR.validate_url,waitMsg:true,waitWnd:this,browserHandler:this,params:{action:"navto-directive",directive:a.value,useRelative:0,mode:""},scope:this,LoadSuccess:function(c,d){if(c.success){d.browserHandler.canvas.setSrc(c.url)}}});break;case"IMAGEEDITOR_CROP":this.canvas.toggleCrop();break;case"IMAGEEDITOR_RESIZE":this.canvas.toggleResize();break;case"IMAGEEDITOR_RESIZERESIZE":this.canvas.resetResizable();break;case"IMAGEEDITOR_UNDO":var b=this.canvas.historyUndo.shift();this.canvas.historyRedo.unshift(b);b=this.canvas.historyUndo.shift();this.canvas.setSrc(b);break;case"IMAGEEDITOR_REDO":var b=this.canvas.historyRedo.shift();this.canvas.setSrc(b);break;case"IMAGEEDITOR_ZOOM":if(this.canvas&&this.canvas.image){this.canvas.setZoom(a.value)}break;case"IMAGEEDITOR_RESET":var b=this.canvas.historyUndo.pop();this.canvas.historyUndo=[];this.canvas.historyRedo=[];this.canvas.setSrc(b);break;case"IMAGEEDITOR_ROTATE":this.canvas.record.data.mode="ROTATE";this.canvas.record.data.rotate=-90;this.executeCmd(this.canvas.record.data,function(c,d){if(c.success){this.canvas.record.data=c.data;this.canvas.setSrc(c.data.src)}},this);break;case"IMAGEEDITOR_FLIPHORZ":this.canvas.record.data.mode="FLIPHORZ";this.executeCmd(this.canvas.record.data,function(c,d){if(c.success){this.canvas.record.data=c.data;this.canvas.setSrc(c.data.src)}},this);break;case"IMAGEEDITOR_FLIPVERT":this.canvas.record.data.mode="FLIPVERT";this.executeCmd(this.canvas.record.data,function(c,d){if(c.success){this.canvas.record.data=c.data;this.canvas.setSrc(c.data.src)}},this);break;case"IMAGEEDITOR_APPLY":if(this.canvas.record.data.mode!=""){this.executeCmd(this.canvas.record.data,function(c,d){if(c.success){this.canvas.record.data.mode="";this.canvas.toggleResize(false);this.canvas.toggleCrop(false);this.canvas.record.data=c.data;this.canvas.record.data.mode="";this.canvas.setSrc(c.data.src);if(this.closeOnEnd){this.closeOnEnd=false;this.hide();if(this.onFinish){this.onFinish(this,this.canvas.record.data)}}}},this)}else{if(this.closeOnEnd){this.closeOnEnd=false;this.hide();if(this.onFinish){this.onFinish(this,this.canvas.record.data)}}}break}},executeCmd:function(c,d,a){var b=AuIt.App.getActionMgr().getAction("APPLY","ImageEditor");b.actionMgr.request(b,{directCall:true,url:AUIT_EDITOR.validate_url,waitMsg:true,waitWnd:this,params:{action:"imageedit",data:c},scope:this,LoadSuccess:function(e,f){if(d){d.call(a||this,e,f)}}})}});