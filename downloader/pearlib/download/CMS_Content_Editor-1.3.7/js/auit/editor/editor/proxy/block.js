Ext.namespace("AuIt.Editor.Block");AuIt.Editor.UndoManager=function(a){a=a||{};Ext.apply(this,a);this.init();AuIt.Editor.UndoManager.superclass.constructor.call(this)};Ext.extend(AuIt.Editor.UndoManager,Ext.util.Observable,{index:0,data:null,lastEntry:null,init:function(a){this.clear()},add:function(d){var c=this;var b=d.el.dom.innerHTML;var a=b.replace(/(id="[^"]+")/g,"");a=a.replace(/( |\t|\n)/g,"");if(this.lastEntry==a){return}this.lastEntry=a;c.addHTML(b)},addHTML:function(b){var a=this;a.index++;a.data[a.index]=b;if((a.index+1)<a.data.length){while(a.data.length>(a.index+1)){a.data.pop()}}},undo:function(c){var b=this;if(b.hasUndo()){b.index--;var a=b.data[b.index];c.setNewHTML(a)}},redo:function(c){var b=this;if(b.hasRedo()){b.index++;var a=b.data[b.index];c.setNewHTML(a)}},setHTML:function(b,a){this.add(b);b.setNewHTML(a)},clear:function(){var a=this;a.data=[];a.index=-1},hasUndo:function(){return this.index>0},hasRedo:function(){return(this.index>=0)&&(this.index<this.data.length-1)}});AuIt.Editor.Block.Basis=function(b,a){this.DomID=b.id;this.el=Ext.get(b);Ext.apply(this,a);this.init();AuIt.Editor.Block.Basis.superclass.constructor.call(this)};Ext.extend(AuIt.Editor.Block.Basis,Ext.util.Observable,{activeAlways:false,modified:false,blocktype:"basis",proxyTitle:"",proxys:null,proxysTip:null,proxyIconOffsetX:0,getActionMgr:function(){return AuIt.App.getActionMgr()},isInlineBlock:function(){return false},getUndoMgr:function(){return this.undoMgr},setHTML:function(a){if(this.undoMgr){this.undoMgr.setHTML(this,a)}this.getActionMgr().updateState()},addUndo:function(){if(this.undoMgr){this.undoMgr.add(this)}},hasUndo:function(){if(this.undoMgr){return this.undoMgr.hasUndo()}return false},hasRedo:function(){if(this.undoMgr){return this.undoMgr.hasRedo()}return false},onUndo:function(){if(this.undoMgr){this.undoMgr.undo(this)}},onRedo:function(){if(this.undoMgr){this.undoMgr.redo(this)}},initUndo:function(){this.undoMgr=new AuIt.Editor.UndoManager();this.addUndo()},init:function(){this.inlineBlocks=[];this.initAnker();this.checkInlineBlocks();this.initEvents();this.createProxy();if(1||this.getActionMgr().getAction("SHOWOMS").isPressed()){this.showBox()}else{this.hideBox()}Ext.EventManager.on(this.el.dom,{drop:this.ondrop,scope:this})},ondrop:function(c){return false;var b=c.browserEvent.dataTransfer;console.log("ondrop");var a=b.getData("text/plain");console.log(a);var a=b.getData("text/x-moz-url-data");console.log(a);var a=b.getData("text/_moz_htmlcontext");console.log(a);var a=b.getData("text/_moz_htmlinfo");console.log(a);var a=b.getData("text/html");console.log(a);c.stopEvent();return true},getDom:function(){return this.el?this.el.dom:null},getEl:function(){return this.el},setNewHTML:function(a){if(this.isInlineBlock()){return}this.el.dom.innerHTML=a;this.checkInlineBlocks()},initAnker:function(){if(this.isInlineBlock()){return}Ext.select("a",true,this.el.dom).each(function(b){var c=b.dom.href;if(c.indexOf("##")>=0){b.dom.auit_href=c;c=c.replace(/(##[^\#]+##)/,"");b.dom.href=c}})},resetAnker:function(){if(this.isInlineBlock()){return}Ext.select("a",true,this.el.dom).each(function(b){if(b.dom.auit_href){b.dom.href=b.dom.auit_href}b.dom.auit_href=null})},destroy:function(){var c;this.destroyInlineBlocks();this.destroyEvents();for(c in this.proxys){if(this.proxys.hasOwnProperty(c)){try{this.proxys[c].remove()}catch(b){}}}if(this.proxysTip){this.proxysTip.destroy()}this.proxysTip=null;this.proxys=null;try{Ext.ComponentMgr.unregister(this);Ext.EventManager.removeAll(this);this.purgeListeners()}catch(a){}},initEvents:function(){var a=this.getActionMgr();a.on("cmd",this.onCmd,this);a.on("itemchanged",this.onItemChanged,this)},destroyEvents:function(){var a=this.getActionMgr();a.un("cmd",this.onCmd,this);a.un("itemchanged",this.onItemChanged,this)},canSave:function(a){return true},addSaveDataLocal:function(a){this.resetAnker();if(!a.useElm){var b=this.el.select("img").each(function(c){if(c.dom.naturalWidth!=c.dom.width||c.dom.naturalHeight!=c.dom.height){c.dom.setAttribute("resize_width",c.dom.width);c.dom.setAttribute("resize_height",c.dom.height)}})}a.addSaveData({page_id:this.pagedata.page_id,typ:"XHTML",factory:this.pagedata.factory,storeId:this.pagedata.storeId,data_field:this.data_field,xhtml:a.useElm?"<div>"+AuIt.Editor.utils.nodeToXML(a.useElm.dom)+"</div>":AuIt.Editor.utils.nodeToXML(this.el.dom)});this.initAnker()},addSaveData:function(a){this.setEditable(false);if(this.isDirty()&&this.iscontentEditable()){this.addSaveDataLocal(a)}return true},destroyInlineBlocks:function(){Ext.each(this.inlineBlocks,function(a){a.destroy()});this.inlineBlocks=[]},checkInlineBlocks:function(a){this.destroyInlineBlocks();if(this.getEl()){this.el.select("div.auit-edit-block-inline",true).each(function(b){var c=Ext.get(b);if(!c){alert("checkInlineBlocks Kein Elem")}this.inlineBlocks.push(new AuIt.Editor.Block.InlineBlock(b,{containerBlock:this}))},this)}},commitChanges:function(a){this.modified=false;if(this.undoMgr){this.undoMgr.clear()}},createProxy:function(){if(this.proxys){return}this.proxys={};var a=Ext.get(this.editor.doc.body);this.proxys.marker=this.el.createProxy({tag:"div",title:this.proxyTitle,cls:"auit-edit-proxy auit-edit-proxy-"+this.blocktype+" "+(this.useshim?"auit-edit-shim":""),style:{position:"absolute"}},a,true);a.appendChild(this.proxys.marker);if(this.useshim){}this.proxys.top=this.el.createProxy({tag:"div",cls:"auit-edit-proxy  auit-edit-top",style:{position:"absolute"}},a,true);this.proxys.right=this.el.createProxy({tag:"div",cls:"auit-edit-proxy  auit-edit-right",style:{position:"absolute"}},a,true);this.proxys.bottom=this.el.createProxy({tag:"div",cls:"auit-edit-proxy auit-edit-bottom",style:{position:"absolute"}},a,true);this.proxys.left=this.el.createProxy({tag:"div",cls:"auit-edit-proxy auit-edit-left",style:{position:"absolute"}},a,true);this.proxys.marker.on({click:{fn:this.toogleEditable,scope:this},mouseover:{fn:function(){},scope:this},mouseout:{fn:function(){},scope:this}});this.el.on("dblclick",function(){this.setEditable(true)},this);this.syncBox()},checkElement:function(){var a=Ext.get(this.editor.doc.getElementById(this.DomID));if(!a){this.editor.setActiveBlock(this,false);this.hideBox()}if(!this.el&&a&&this.getActionMgr().getAction("SHOWOMS").isPressed()){this.el=a;this.showBox()}this.el=a},syncBox:function(){if(!this.el){return}var h={},d={};Ext.apply(d,this.el.dom.getBoundingClientRect());h.top=this.el.dom.ownerDocument.documentElement.scrollTop;h.left=this.el.dom.ownerDocument.documentElement.scrollLeft;d.y=Math.round(d.top);d.x=Math.round(d.left);d.width=Math.round(d.width);d.height=Math.round(d.height);var f=true;if(this.lastBoxSize){f=false;if(Math.abs(this.lastBoxSize.y-(d.y+h.top))>1||Math.abs(this.lastBoxSize.x-(d.x+h.left))>1||Math.abs(this.lastBoxSize.width-d.width)>1||Math.abs(this.lastBoxSize.height-d.height)>1){f=true}}if(f){var a,c,i,g=0,b,j=0;if(!this.isInlineBlock()){var e=this.editor;g=parseInt(d.y/32,10);i=parseInt(d.x/32,10);if(this.lastBoxSize){b=this.lastBoxSize.rasterY;if(b!=g){c=e.blockFrameCoord[b];for(a in c){if(c.hasOwnProperty(a)){if(a==this.el.id){delete c[a];j=0;break}}}}}if(e.blockFrameCoord[g]){c=e.blockFrameCoord[g];for(a in c){if(c.hasOwnProperty(a)){if(a==this.el.id){break}if(c[a]==i){j++}}}j*=32}else{if(!this.editor.blockFrameCoord[g]){this.editor.blockFrameCoord[g]={}}this.editor.blockFrameCoord[g][this.el.id]=i}}if(1||!this.useshim){this.proxys.marker.setBox({x:d.x-this.proxyIconOffsetX-j+5,y:d.y-14,width:32,height:32})}else{this.proxys.marker.setBox({x:d.x-this.proxyIconOffsetX,y:d.y,width:d.width,height:d.height})}this.proxys.top.setBox({x:d.x,y:d.y,width:d.width,height:1});this.proxys.right.setBox({x:d.right,y:d.y,width:1,height:d.height});this.proxys.bottom.setBox({x:d.x,y:d.bottom,width:d.width,height:1});this.proxys.left.setBox({x:d.x,y:d.y,width:1,height:d.height});this.lastBoxSize={xb:d.x,yb:d.y,rasterY:g,x:d.x+h.left,y:d.y+h.top,width:d.width,height:d.height}}},showBox:function(a){if(a!==true){this.syncBox()}for(var b in this.proxys){if(this.proxys.hasOwnProperty(b)){this.proxys[b].show()}}},hideBox:function(){for(var a in this.proxys){if(this.proxys.hasOwnProperty(a)){this.proxys[a].hide()}}},iscontentEditable:function(){return true},isEditable:function(){if(this.el&&this.el.getAttribute("contentEditable")==="true"){return true}return false},toogleEditable:function(){this.setEditable(!this.isEditable())},setEditable:function(a){var c,b=this.isEditable();if(!a&&b){for(c in this.proxys){if(this.proxys.hasOwnProperty(c)){this.proxys[c].removeClass("editable")}}this.editor.setActiveBlock(this,false)}else{if(a&&!b){for(c in this.proxys){if(this.proxys.hasOwnProperty(c)){this.proxys[c].addClass("editable")}}this.editor.setActiveBlock(this,true)}}},setContentEditable:function(a){if(a&&!this.el.isContentEditable()){this.getEl().setContentEditable(true);this.editor.doc.execCommand("insertbronreturn",false,false)}if(!a&&this.el.isContentEditable()){this.getEl().setContentEditable(false)}if(this.el.isContentEditable()){this.getEl().focus()}},deActive:function(){},onItemChanged:function(a){},onCmd:function(a){if(a.itemId=="SHOWOMS"){if(a.data.value){this.showBox()}else{this.hideBox()}}},setModified:function(){if(!this.modified){this.modified=true;this.getActionMgr().updateState()}},isDirty:function(){return this.modified},watchTask:function(){this.syncBox();Ext.each(this.inlineBlocks,function(a){a.watchTask()})}});AuIt.Editor.Block.CMSPage=Ext.extend(AuIt.Editor.Block.Basis,{proxyTitle:AuIt.locale.Block_CMSPage,proxyIconOffsetX:32,blocktype:"block-cms-page"});AuIt.Editor.Block.CategoryPage=Ext.extend(AuIt.Editor.Block.CMSPage,{proxyTitle:AuIt.locale.Block_CategoryPage,proxyIconOffsetX:32,blocktype:"block-cms-block"});AuIt.Editor.Block.ProductPage=Ext.extend(AuIt.Editor.Block.CMSPage,{proxyTitle:AuIt.locale.Block_ProductPage,proxyIconOffsetX:32,blocktype:"block-cms-block"});AuIt.Editor.Block.CMSBlock=Ext.extend(AuIt.Editor.Block.CMSPage,{proxyTitle:AuIt.locale.Block_CMSBlock,proxyIconOffsetX:32,blocktype:"block-cms-block"});AuIt.Editor.Block.Blog=Ext.extend(AuIt.Editor.Block.CMSPage,{proxyTitle:AuIt.locale.Block_Blog,proxyIconOffsetX:32,blocktype:"block-cms-block",setEditable:function(a){if(AuIt.App.l==1){AuIt.Editor.Block.Blog.superclass.setEditable.call(this,a)}else{AuIt.App.getActionMgr().showMessage(AuIt.locale.p)}}});AuIt.Editor.Block.InlineBlock=Ext.extend(AuIt.Editor.Block.CMSPage,{proxyTitle:AuIt.locale.Block_InlineBlock,activeAlways:true,proxyIconOffsetX:16,blocktype:"block-inline",useshim:true,simEdit:false,isInlineBlock:function(){return true},removeBlock:function(){var a=this.containerBlock;a.setModified();a.addUndo();Ext.removeNode(this.el.dom);this.el.remove();a.checkInlineBlocks()},init:function(){this.editor=this.containerBlock.editor;this.data_field={name:"source"};this.pagedata={factory:"InlineBlock",data:{data:{source:this._getSourceData()},modifiedData:{},use_store:{}},desc:this._getpropertyPanelDesc()};if(this.pagedata.desc){}AuIt.Editor.Block.InlineBlock.superclass.init.call(this);this.el.dom.setAttribute("contentEditable",false)},replaceHTMLBlock:function(c){this.containerBlock.setModified();this.containerBlock.addUndo();var a=new Ext.DomHelper.createTemplate(c);var b=a.insertBefore(this.el,[],true);Ext.removeNode(this.el.dom);this.el.remove();this.el=null;var d=this.containerBlock;d.checkInlineBlocks();Ext.each(d.inlineBlocks,function(e){if(e.el==b){e.editor.setActiveBlock(e,true);return false}})},setModified:function(){var a=this.pagedata.data.modifiedData[this.data_field.name];if(a!==undefined){if(this._getSourceData()!=a){this.containerBlock.addUndo();this._setSourceData(a);this.containerBlock.setModified()}}},_getpropertyPanelDesc:function(){var a=null;this.el.select("div.auit-edit-inlineblock-description/div.desc").each(function(c){try{a=Ext.decode(Base64.decode(c.dom.innerHTML))}catch(d){var b=1}},this);return a},_getSourceData:function(){var a="";this.el.select("div.auit-edit-inlineblock-description/div.source").each(function(b){a=Base64.decode(b.dom.innerHTML)},this);return a},_setSourceData:function(a){this.el.select("div.auit-edit-inlineblock-description/div.source").each(function(b){b.dom.innerHTML=Base64.encode(a)},this)},iscontentEditable:function(){return false},isEditable:function(){return this.simEdit},deActive:function(){this.simEdit=false;for(var a in this.proxys){if(this.proxys.hasOwnProperty(a)){this.proxys[a].removeClass("editable")}}},setEditable:function(a){this.simEdit=!a;AuIt.Editor.Block.InlineBlock.superclass.setEditable.call(this,a)},setContentEditable:function(a){},destroy:function(){if(this.propertyPanel){this.propertyPanel.destroy()}this.propertyPanel=null;AuIt.Editor.Block.InlineBlock.superclass.destroy.call(this)}});