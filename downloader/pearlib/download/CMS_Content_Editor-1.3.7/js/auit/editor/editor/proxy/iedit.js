Ext.namespace("AuIt.Editor.PEdit");AuIt.Editor.PEdit=function(a){Ext.apply(this,a);AuIt.Editor.PEdit.superclass.constructor.apply(this,arguments)};Ext.extend(AuIt.Editor.PEdit,AuIt.Editor.Base,{iframeUID:"",activeProperty:null,modified:false,lastCommand:null,UniqID:1,text_title:AuIt.locale.PEdit_T1,text_Unload:AuIt.locale.PEdit_T2,text_Unload2:AuIt.locale.PEdit_T3,init:function(){this.triggerAttribute=null;this.altKeyMap={};this.AUIT_PAGEDATA=parent.AUIT_PAGEDATA;this.iframeUID=parent.window.name;this.actionMgr=new AuIt.ProxyActionMgr({modul:"Editor",editor:this,iframeUID:this.iframeUID,proxy_origin:this.AUIT_PAGEDATA.BASE_URL});var a=this.getActionMgr();a.on("beforecmd",this.onbeforeCmd,this);a.on("beforerequest",this.onbeforeRequest,this);a.on("cmd",this.onCmd,this);a.on("aftercmd",this.onafterCmd,this);var b=a.getAction("CMD_IFRAMEMSG","iframe");b.data={itemId:"EDITFRAME_INIT",title:parent.document.title,AUIT_PAGEDATA:this.AUIT_PAGEDATA};b.postMessage();a.on("watchtask",this.watchTask,this)},getActionMgr:function(){return this.actionMgr},globalKeys:function(b){if(b.keyCode==b.F1){this.lastKeyCode="GF1";b.preventDefault();return}if(!b.altKey){return}var a,d=b.getCharCode();if(d>0){d=String.fromCharCode(d);if((a=this.altKeyMap[d])){b.preventDefault();this.lastKeyCode=d}}},watchTask:function(){if(this.ignoreChecked){return}Ext.each(this.blocks,function(a){if(a.property){a.property.watchTask()}Ext.each(a.frames,function(b){b.watchTask()},this)},this)},onbeforeCmd:function(a){switch(a.itemId){case"MAIN_TAB_CHANGE":if(a.currentTab==this){if(!this.validPropertys()){return false}}break;case"SAVE":Ext.each(this.blocks,function(b){Ext.each(b.frames,function(c){if(!c.canSave(a)){return false}},this)},this);return a.canSave;case"SAVEALL":Ext.each(this.blocks,function(b){Ext.each(b.frames,function(c){if(!c.canSave(a)){return false}},this)},this);return a.canSave;default:a.editor=this;break}},onbeforeRequest:function(a){switch(a.itemId){case"SAVE":Ext.each(this.blocks,function(b){Ext.each(b.frames,function(c){c.addSaveData(a)},this)},this);break;case"SAVEALL":Ext.each(this.blocks,function(b){Ext.each(b.frames,function(c){c.addSaveData(a)},this)},this);break}},getEditElement:function(){if(!this.activeBlock||this.activeBlock.isInlineBlock()){return null}var a=this.getSelection().getNode();if(!a||!a.isInContentEditable()){return null}if(this.activeBlock.el==a){return null}return a},getUniqDomID:function(a){if(!a){return"?NOID?"}if(!a.auitUniqID){this.UniqID++;a.auitUniqID=a.tagName+"_"+this.UniqID}return a.auitUniqID},getUniqDom:function(c){var b=null,a=String(c).split("_");if(a.length<=1){return b}var d=this.getContentElm();if(!d){return b}Ext.each(d.dom.getElementsByTagName(a[0]),function(f){if(f.auitUniqID==c){b=f;return false}});return b},onCmd:function(f){switch(f.itemId){case"CMD_IFRAMEMSG":switch(f.data.itemId){case"EDITSTATES":if(this.iframeUID==f.iframeUID){this.editStates=f.data.states;AuIt.App.l=f.data.lstate;this.altKeyMap=f.data.altKeyMap;this.initEditor()}break}break;case"INTERN_MAIN_TAB_CHANGE":Ext.each(this.blocks,function(a){Ext.each(a.frames,function(e){e.setEditable(false)},this)},this);break;case"CSS_SET":this.lastCommand=f.itemId;var h=this.getEditElement();if(h){this.Transaction(function(){if(f.data.reset){if(h.saveStyleCSS){h.dom.style.cssText=h.saveStyleCSS.style;h.dom.className=h.saveStyleCSS.classname;h.saveStyleCSS=null}}else{if(f.data.preview&&!h.saveStyleCSS){h.saveStyleCSS={style:h.dom.style.cssText,classname:h.dom.className}}if(!f.data.preview){h.saveStyleCSS=null}h.dom.style.cssText=f.data.style;h.dom.className=f.data.classname}},f.preview)}f.answer();break;case"CSS_RESET":this.lastCommand=f.itemId;var h=this.getEditElement();if(h){this.Transaction(function(){h.dom.className="";h.dom.style.cssText=""})}break;case"ELEMENT_DEL":this.lastCommand=f.itemId;var h=this.getEditElement();if(h){this.Transaction(function(){h.dom.parentNode.removeChild(h.dom)})}break;case"INLINEBLOCK_DEL":if(!this.activeBlock||!this.activeBlock.isInlineBlock()){return}this.activeBlock.removeBlock();break;case"INTERN_SELECTNODE":var c=this.getUniqDom(f.data.value);this.getSelection().selectNode(c);break;case"ELEMENT_IMG_RESET":this.lastCommand=f.itemId;var h=this.getEditElement();if(h){this.Transaction(function(){h.dom.removeAttribute("width");h.dom.removeAttribute("height");h.dom.style.width="";h.dom.style.height=""})}break;case"INTERN_SETHTMLATTRIBUTE":var k=f.data.a,g=this.getUniqDom(f.data.domID),l=f.data.value;try{if(k=="href"){var b=l;if(b.indexOf("##")>=0){g.auit_href=b;b=b.replace(/(##[^\#]+##)/,"")}g.href=b}else{g[k]=l}}catch(h){}break;case"INTERN_SETHTMLEVENTS":var k=f.data.a,g=this.getUniqDom(f.data.domID),l=f.data.value;try{g[k]=l}catch(h){}break;case"INTERN_DOMINFO":var i=this.getEditElement();f.data={};if(i){f.data={style:i.dom.style.cssText,classname:i.dom.className}}break;case"INTERN_PAGEPART_ADD":var i=this.getEditElement();f.data={};if(i&&i.dom&&this.activeBlock){var j={itemId:"TRANSLATE_HTML_TO_LOCAL",browser:this,_data:[],addSaveData:function(a){this._data=a}};j.useElm=i;this.activeBlock.addSaveDataLocal(j);j.useElm=null;f.data=j._data}break;case"INTERN_SETHTMLCSS":var k=f.data.a,g=this.getUniqDom(f.data.domID),l=f.data.value;try{g.style[k]=l}catch(h){}break;case"INTERN_REPLACEHTMLBLOCK":var d=this.getActiveBlock();if(d){d.replaceHTMLBlock(f.data.xhtml)}break;case"INTERN_SETSTOREMODE":var d=this.getActiveBlock();if(d){d.data_field.use_store=f.data.use_store;d.setModified()}this.setLastFocus();this.setModified();break}},execCmd:function(b,a){this.lastCommand=b;switch(b){default:this.Transaction(function(){AuIt.Editor.PEdit.superclass.execCmd.call(this,b,a);if(b=="inserthtml"&&this.activeBlock){this.activeBlock.checkInlineBlocks()}});break}this.lastCommand=null},_reloadWindow:function(){this.modified=false;var b=this.getWin();if(b){try{b.location.reload()}catch(a){}}},onafterCmd:function(b,a){if(b.itemId=="STATIC_BLOCKS_DUP"){if(a.success){if(a.reload){this._reloadWindow();return}}}else{if(b.itemId=="SAVE"||b.itemId=="SAVEALL"){if(a.success){if(a.reload){this._reloadWindow();return}this.ignoreChecked=true;Ext.each(this.blocks,function(c){Ext.each(c.frames,function(d){d.commitChanges(b)},this)},this);this.ignoreChecked=false;this.modified=false}}}if(b.itemId!="CMD_UNDO"&&b.itemId!="CMD_REDO"){}},doFrameBeforeUnload:function(a){if(this.modified){a.browserEvent.returnValue=this.text_title+"\n"+this.text_Unload+"\n\n"+this.text_Unload2+"\n";return false}},checkBeforeClosing:function(a){if(!this.modified){return true}Ext.MessageBox.show({title:this.text_title,msg:this.text_Unload.replace("\n","<br/>"),buttons:Ext.MessageBox.YESNO,fn:function(b){if(b=="no"){if(a.go){this.modified=false;a.go.call(this)}}},scope:this,icon:Ext.MessageBox.QUESTION});return false},doFrameUnload:function(a){},onImgDblClick:function(b,a,c){},onAnkerDblClick:function(b,a,c){},onBodyClick:function(a){a.stopEvent();return false},onAnkerClick:function(a){a.stopEvent();return false},getDoc:function(){return this.doc},getWin:function(){return this.win},initEditor:function(){this.blockFrameCoord={};this.doc=parent.document;this.win=parent.window;Ext.EventManager.on(this.doc,"keydown",this.globalKeys,this);Ext.EventManager.on(this.win,"beforeunload",this.doFrameBeforeUnload,this);Ext.EventManager.on(this.win,"unload",this.doFrameUnload,this);AuIt.Editor.PEdit.superclass.initEditor.apply(this,arguments);this.initBlocks()},initBlocks:function(){this.blocks=[];var d=this.AUIT_PAGEDATA;if(!d){return}var e=null;if(d.MAIN){var c=d.MAIN.factory;this.window_id=d.MAIN.window_id;if(1){var f={};f.typ="MAIN";f.frames=[];if(d.MAIN.blockIds){for(var a in d.MAIN.blockIds){if(d.MAIN.blockIds.hasOwnProperty(a)){var b=this.doc.getElementById(a);if(b){e=new AuIt.Editor.Block[c](b,{editor:this,pagedata:d.MAIN,propertyFact:c,data_field:d.MAIN.blockIds[a]});this.mainBlock=e;f.frames.push(e)}}}}this.blocks.push(f)}}if(d.SUB){Ext.each(d.SUB,function(g){var j=g.factory;if(g.blockIds){var k={};k.typ="SUB";k.frames=[];for(var h in g.blockIds){if(g.blockIds.hasOwnProperty(h)){var i=this.doc.getElementById(h);if(i&&!Ext.fly(i).isInEditBlock()){e=new AuIt.Editor.Block[j](i,{editor:this,pagedata:g,propertyFact:j,data_field:g.blockIds[h]});k.frames.push(e)}}}this.blocks.push(k)}},this)}Ext.each(this.blocks,function(g){Ext.each(g.frames,function(h){h.initUndo()},this)},this)},getActiveBlock:function(){return this.activeBlock},setActiveBlockforDom:function(a){if(!a){return}Ext.each(this.blocks,function(b){Ext.each(b.frames,function(c){if(c.getDom()==a){if(this.activeBlock!=c){this.setActiveBlock(c,true)}return false}},this)},this)},deActiveBlock:function(){if(this.activeBlock){this.activeBlock.deActive()}},setActiveBlock:function(b,a){if(!b){if(this.activeBlock&&this.activeBlock.iscontentEditable()){this.deActiveBlock();this.activeBlock=null}else{return}}else{if(a){this.deActiveBlock();this.activeBlock=b}else{if(!a&&this.activeBlock==b){this.deActiveBlock();this.activeBlock=null}}}if(b){b.setContentEditable(a)}this.getActionMgr().updateState()},getContentElm:function(){if(this.activeBlock&&this.activeBlock.isEditable()){return this.activeBlock.getEl()}return null},onUndo:function(){if(this.activeBlock){this.activeBlock.onUndo();this.activeBlock.checkInlineBlocks()}},onRedo:function(){if(this.activeBlock){this.activeBlock.onRedo();this.activeBlock.checkInlineBlocks()}},onCut:function(f,d,i){var h=this.getSelection().getNode();var g=h?h.isInContentEditable():false;if(!g){this.setActiveBlock(null)}else{this.setActiveBlockforDom(g)}if(this.activeBlock){this.activeBlock.checkInlineBlocks()}this.watchTask();this.setModified();this.addUndo()},onPaste:function(f,d,i){var h=this.getSelection().getNode();var g=h?h.isInContentEditable():false;if(!g){this.setActiveBlock(null)}else{this.setActiveBlockforDom(g)}this.cleanUp();if(this.activeBlock){this.activeBlock.checkInlineBlocks()}this.watchTask();this.setModified();this.addUndo()},onCopy:function(g,f,j,i,h){},onNodeRemove:function(g,f,j,i,h){},onNodeInsert:function(g,f,j,i,h){},onCharacterDataModified:function(g,f,j,i,h){this.setModified();this.addUndo()},onDragEnd:function(b){var b=this.getSelection().getNode();var a=b?b.isInContentEditable():false;if(a){this.setActiveBlockforDom(a)}if(this.activeBlock){this.activeBlock.checkInlineBlocks()}},updateToolbar:function(d,f){try{var g=this.getSelection().getNode();var c=g?g.isInContentEditable():false;if(!c){this.setActiveBlock(null)}var i=null;if(f&&g){if(f.type=="dblclick"){switch(g.dom.nodeName){case"IMG":i="src";break;case"A":i="href";break}}}if(!c&&this.lastEditNode==g&&!i){return}var a=c!==null;this.setActiveBlockforDom(c);this.addUndo();if(this.activeBlock){if(!this.modified&&this.activeBlock.hasUndo()){this.setModified()}}var h=null;if(i){this.triggerAttribute={attr:i,panel:["E","A"]}}this.getActionMgr().updateState();this.lastEditNode=g;this.triggerAttribute=null}catch(b){this.getActionMgr().updateState()}},Transaction:function(b,a){b.call(this);if(!a){this.addUndo();this.setModified()}},addUndo:function(){if(this.activeBlock){this.activeBlock.addUndo()}},setLastFocus:function(){this.focus()},setModified:function(){if(!this.modified){this.modified=true}if(this.activeBlock){this.activeBlock.setModified()}this.getActionMgr().updateState()},badTags:{LINK:1,STYLE:1,META:1,SCRIPT:1,TITLE:1,FORM:1,HEAD:1},badAtt:{contenteditable:1},cleanUp:function(){if(!this.activeBlock){return}this.cleanDom(this.activeBlock.getDom())},cleanDom:function(g){if(!g){return false}var c,a,f=g.childNodes;var e=[];var b=false;for(c=0,a=f.length;c<a;c++){var d=f[c];switch(d.nodeType){case 1:if(/(O:|V:)/.test(d.nodeName)){e.push(d)}else{if(d.AUIT_INIT!=1&&this.badTags[d.nodeName]){e.push(d)}else{if(d.nodeName=="IMG"&&d.src.indexOf("file:")>=0){e.push(d)}else{this.cleanDom(d);d.removeAttribute("id");if(/Mso/.test(d.className)){d.removeAttribute("class")}this.cleanDom(d);if(d.nodeName=="P"&&d.innerHTML===""){d.innerHTML="&#160;"}}}}break;case 3:d.nodeValue=d.nodeValue.replace("\n"," ");break;case 2:break;case 8:if(d.AUIT_INIT!=1){e.push(d)}break;default:break}}for(c=0,a=e.length;c<a;c++){g.removeChild(e[c]);b=true}return b},onqueryState:function(c){var a;if(c.actionGroup=="EDITOR"){switch(c.itemId){case"CMD_UNDO":if(this.activeBlock){c.editEnabled=this.activeBlock.hasUndo()}return false;case"CMD_REDO":if(this.activeBlock){c.editEnabled=this.activeBlock.hasRedo()}return false;case"CMD_INSERTWIDGET":case"CMD_INSERTMEDIA":if(this.activeBlock){c.editEnabled=true;a=this.getSelection().getNode();if(!a||a.findParent("img")){c.editEnabled=false}}return false}var b=c.itemId.substr(4).toLowerCase();if(c.enableToggle){c.state=this.queryCommandState(b)}c.editEnabled=this.queryCommandEnabled(b);if(c.value!==undefined){c.value=this.queryCommandValue(b)}if(c.editEnabled){switch(c.itemId){case"CMD_INSERTIMAGE":c.editEnabled=true;a=this.getSelection().getNode();if(!a||a.findParent("img")){c.editEnabled=false}break;case"CMD_CREATELINK":c.editEnabled=true;a=this.getSelection().getNode();if(!a||a.findParent("a")||(a.dom.tagName!="IMG"&&this.getSelection().isEmpty())){c.editEnabled=false}break;case"CMD_UNLINK":c.editEnabled=false;a=this.getSelection().getNode();if(a&&a.findParent("a")){c.editEnabled=true}break}}return false}},addBlockData:function(){var b=this.activeBlock;var a={DomID:0,isScopeStore:false,use_store:0,fieldLabel:"",storeName:""};if(b&&b.DomID){a.DomID=b.DomID}if(b&&b.isInlineBlock()){a.isInline=true;a.pagedata=b.pagedata}return a},isDirty:function(){if(!this.modified){Ext.each(this.blocks,function(a){Ext.each(a.frames,function(b){if(b.isDirty()){this.modified=true}},this)},this)}return this.modified},updateStateOpt:function(){var h=this.getSelection().getNode();var b=h?(h.isInContentEditable()?true:false):false;var j=this.getEditElement();var g={};var i={};var f={};var c="";var l="";if(j&&b){var m=parent.getComputedStyle(j.dom,"");var n=j.dom.tagName;if(!AuIt.Editor.htmlProperty.Tags[n]){n="DEFAULT"}var k=AuIt.Editor.htmlProperty.Tags[n];Ext.each(k,function(d){Ext.each(AuIt.Editor.htmlProperty.AttributeGroups[d],function(e){if(e[5]=="href"&&j.dom.auit_href){g[e[5]]=""+j.dom.auit_href}else{g[e[5]]=""+j.dom[e[5]]}})});var a=j.dom.style;Ext.each(AuIt.Editor.htmlProperty.CSSData,function(d){f[d[5]]=m[d[5]];i[d[5]]=a[d[5]]});c=j.dom.style.cssText;l=j.dom.className}return{source:"EDITOR",domID:this.getUniqDomID(j&&j.dom?j.dom:null),tagName:(j&&j.dom)?j.dom.tagName:"",isEditable:b,dom:g,style:i,className:l,cssText:c,compStyle:f,modified:this.isDirty(),inBlockElm:h?h.getParentBlockNode():false,collapsed:h?this.getSelection().getRange().collapsed:true}},htmlXPathStatus:function(){var b,c=this.getSelection().getNode();if(c){if(!c.isInContentEditable()){b=c=null}else{b=c=c.dom}}var a=[];while(c){if(c.nodeType==1&&c.getAttribute){var d=c.getAttribute("contentEditable");if(d==="false"||d==="true"){break}a.push({text:""+c.tagName,remoteId:this.getUniqDomID(c),enableToggle:true,pressed:c==b?true:false})}c=c.parentNode}return a},sendEditStates:function(b){if(!this.editStates){return}for(var d in this.editStates){var c=this.editStates[d];this.onqueryState(c)}var a=this.getActionMgr();var c=a.getAction("CMD_IFRAMEMSG","iframe");c.data={itemId:"EDITFRAME_UPDATESTATES",opt:this.updateStateOpt(),proxyStates:this.editStates,htmlXPathStatus:this.htmlXPathStatus(),blockData:this.addBlockData(),KeyCode:this.lastKeyCode,triggerAttribute:this.triggerAttribute};c.postMessage();this.lastKeyCode=0}});Ext.onReady(function(){AuIt.App=new AuIt.Editor.PEdit();AuIt.App.init()});