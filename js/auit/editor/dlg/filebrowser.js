Ext.namespace("AuIt.Editor","AuIt.tree","AuIt.Action.ToolBar.FileBrowser","AuIt.Action.FileBrowser","AuIt.Editor.Directive");AuIt.tree.FileNode=Ext.extend(Ext.tree.TreeNode,{refreshView:function(){this.text=this.attributes.text;if(this.ui){this.ui.refreshView(this)}}});AuIt.tree.DirNode=Ext.extend(Ext.tree.AsyncTreeNode,{});AuIt.tree.DirNodeUI=Ext.extend(Ext.ux.tree.TreeGridNodeUI,{render:function(c){var e=this.node,b=e.attributes;var d=e.parentNode?e.parentNode.ui.getContainer():e.ownerTree.innerCt.dom;if(e.attributes.isdir&&e.parentNode&&e.parentNode.ui.dirCnt){d=e.parentNode.ui.dirCnt}if(!e.attributes.isdir&&e.parentNode&&e.parentNode.ui.fileCnt){d=e.parentNode.ui.fileCnt}if(!this.rendered){this.rendered=true;this.renderElements(e,b,d,c);if(b.qtip){if(this.textNode.setAttributeNS){this.textNode.setAttributeNS("ext","qtip",b.qtip);if(b.qtipTitle){this.textNode.setAttributeNS("ext","qtitle",b.qtipTitle)}}else{this.textNode.setAttribute("ext:qtip",b.qtip);if(b.qtipTitle){this.textNode.setAttribute("ext:qtitle",b.qtipTitle)}}}else{if(b.qtipCfg){b.qtipCfg.target=Ext.id(this.textNode);Ext.QuickTips.register(b.qtipCfg)}}this.initEvents();if(!this.node.expanded){this.updateExpandIcon(true)}}else{if(c===true){d.appendChild(this.wrap)}}},renderElements:function(d,l,h,m){var o=d.getOwnerTree(),k=o.columns,j=k[0],e,b,g;this.indentMarkup=d.parentNode?d.parentNode.ui.getChildIndent():"";b=['<tbody class="x-tree-node">','<tr ext:tree-node-id="',d.id,'" class="x-tree-node-el x-tree-node-leaf ',l.cls,'">','<td class="x-treegrid-col" colspan="'+(k.length-1)+'">','<span class="x-tree-node-indent">',this.indentMarkup,"</span>",'<img src="',this.emptyIcon,'" class="x-tree-ec-icon x-tree-elbow">','<img src="',l.icon||this.emptyIcon,'" class="x-tree-node-icon',(l.icon?" x-tree-node-inline-icon":""),(l.iconCls?" "+l.iconCls:""),'" unselectable="on">','<a hidefocus="on" class="x-tree-node-anchor" href="',l.href?l.href:"#",'" tabIndex="1" ',l.hrefTarget?' target="'+l.hrefTarget+'"':"",">",'<span unselectable="on">',d.text,"</span></a>","</td>"];b.push('<td class="x-treegrid-col">',"<h2><div>Files</div></h2>","</td>",'</tr><tr class="x-tree-node-ct"><td colspan="',k.length,'">','<div class="x-treegrid-node-ct" style="table-layout: fixed; display: none;">');b.push('<div class="snm-gallery-tree-ct snm-gallery clearfix" style="margin-left:'+k[0].width+'px;">',"</div>");b.push('<table class="x-treegrid-node-ct-table" cellpadding="0" cellspacing="0" style="table-layout: fixed; width: ',o.innerCt.getWidth(),'px;"><colgroup>');for(e=0,g=k.length;e<g;e++){b.push('<col style="width: ',(k[e].hidden?0:k[e].width),'px;" />')}b.push("</colgroup></table>");b.push("</div></td></tr></tbody>");if(m!==true&&d.nextSibling&&d.nextSibling.ui.getEl()){this.wrap=Ext.DomHelper.insertHtml("beforeBegin",d.nextSibling.ui.getEl(),b.join(""))}else{this.wrap=Ext.DomHelper.insertHtml("beforeEnd",h,b.join(""))}this.elNode=this.wrap.childNodes[0];this.ctNode=this.wrap.childNodes[1].firstChild.firstChild;this.dirCnt=this.ctNode.childNodes[1];this.fileCnt=this.ctNode.childNodes[0];var f=this.elNode.firstChild.childNodes;this.indentNode=f[0];this.ecNode=f[1];this.iconNode=f[2];this.anchor=f[3];this.textNode=f[3].firstChild},onClick:function(b){if(this.dropping){b.stopEvent();return}var a=b.getTarget("h2",3,true);if(a){Ext.fly(this.fileCnt).toggleClass("collapsed");a.toggleClass("collapsed");b.stopEvent();return}return AuIt.tree.DirNodeUI.superclass.onClick.call(this,b)}});AuIt.tree.FileNodeUI=Ext.extend(AuIt.tree.DirNodeUI,{refreshView:function(a){if(this.textNode.firstChild){this.textNode.firstChild.nodeValue=a.text}this.iconNode.src=a.attributes.icon+"?d="+new Date().getTime();buf=["<b>"+AuIt.locale.FILEBR_SIZE+":</b><br/>",Ext.util.Format.fileSize(a.attributes.size),"<br/><b>"+AuIt.locale.FILEBR_Dimension+":</b><br/>",a.attributes.isize,"<br/><b>"+AuIt.locale.FILEBR_Date+":</b><br/>",Ext.util.Format.date(new Date(a.attributes.date_modified*1000),"d/m/Y H:i")];this.infoNode.innerHTML=buf.join("")},renderElements:function(c,h,g,j){var k=c.getOwnerTree(),d,b,f;if(c.parentNode&&c.parentNode.ui.fileCnt){g=c.parentNode.ui.fileCnt}b=['<div class="x-tree-node snm-gallery-item"  >','<a hidefocus="on" class="x-tree-node-anchor" href="',h.href?h.href:"#",'" tabIndex="1" ',h.hrefTarget?' target="'+h.hrefTarget+'"':"",">",'<div ext:tree-node-id="',c.id,'"  class="x-tree-node-el x-tree-node-leaf ',h.cls,'">','<div class="x-btn-group-tl">','<div class="x-btn-group-tr">','<div class="x-btn-group-tc">','<div class="x-btn-group-header x-unselectable" >','<span class="x-btn-group-header-text" unselectable="on">',c.text,"</span>","</div>","</div>","</div>","</div>",'<div class="x-btn-group-bwrap" >','<div class="x-btn-group-ml">','<div class="x-btn-group-mr x-btn-group-mc x-btn-group-body">',"<h3>",'<img src="',h.icon||this.emptyIcon,'" classx="x-tree-node-icon',(h.icon?" x-tree-node-inline-icon":""),(h.iconCls?" "+h.iconCls:""),'" unselectable="on"/>',"&#160;</h3>","<p>","<b>Size:</b><br/>",Ext.util.Format.fileSize(c.attributes.size),"<br/><b>Dimension:</b><br/>",c.attributes.isize,"<br/><b>Date:</b><br/>",Ext.util.Format.date(new Date(c.attributes.date_modified*1000),"d/m/Y H:i"),"</p>","</div>","</div>",'<div class="x-btn-group-bl x-panel-nofooter" >','<div class="x-btn-group-br">','<div class="x-btn-group-bc"></div>',"</div>","</div>","</div>","</div>",'<div style="display:none">','<span class="x-tree-node-indent"></span>','<img src="',this.emptyIcon,'" class="x-tree-ec-icon x-tree-elbow">',"</div>","</a>","</div>"];if(j!==true&&c.nextSibling&&c.nextSibling.ui.getEl()){this.wrap=Ext.DomHelper.insertHtml("beforeBegin",c.nextSibling.ui.getEl(),b.join(""))}else{this.wrap=Ext.DomHelper.insertHtml("beforeEnd",g,b.join(""))}this.anchor=this.wrap.firstChild;this.elNode=this.wrap.firstChild.firstChild;var e=this.elNode.childNodes;this.textNode=e[0].firstChild.firstChild.firstChild.firstChild;this.iconNode=e[1].firstChild.firstChild.firstChild.firstChild;this.infoNode=e[1].firstChild.firstChild.childNodes[1];this.ctNode=this.wrap.firstChild.childNodes[1];e=this.ctNode.childNodes;this.indentNode=e[0];this.ecNode=e[1]}});AuIt.Action.FileBrowser.REFRESH={actionGroup:"FILEBROWSER",disabled:true,itemId:"FILEBROWSER_REFRESH",iconCls:"auit-filebrowser-refresh",tooltip:AuIt.locale.FILEBR_REFRESH,updateState:function(b){var a=true;if(b.source=="FILEBROWSER"){this.setDisabled(!b.node||!b.node.attributes.isdir)}}};AuIt.Action.FileBrowser.NEW={actionGroup:"FILEBROWSER",disabled:true,itemId:"FILEBROWSER_NEW",iconCls:"auit-filebrowser-icon-newfolder",tooltip:AuIt.locale.FILEBR_NEW,updateState:function(b){var a=true;if(b.source=="FILEBROWSER"){this.setDisabled(!b.node||!b.node.attributes.isdir)}}};AuIt.Action.FileBrowser.RENAME={actionGroup:"FILEBROWSER",disabled:true,itemId:"FILEBROWSER_RENAME",iconCls:"auit-filebrowser-icon-renamefolder",tooltip:AuIt.locale.FILEBR_RENAME,updateState:function(b){var a=true;if(b.source=="FILEBROWSER"){this.setDisabled(!b.node||b.node.attributes.root)}}};AuIt.Action.FileBrowser.DEL={actionGroup:"FILEBROWSER",disabled:true,itemId:"FILEBROWSER_DEL",iconCls:"auit-filebrowser-icon-deletefolder",tooltip:AuIt.locale.FILEBR_DEL,confirmDeleteFolderTitleText:AuIt.locale.FILEBR_DEL_1,confirmDeleteFolderMsgText:AuIt.locale.FILEBR_DEL_2,confirmDeleteSingleFileTitleText:AuIt.locale.FILEBR_DEL_3,confirmDeleteSingleFileMsgText:AuIt.locale.FILEBR_DEL_4,confirmDeleteMultipleFileTitleText:AuIt.locale.FILEBR_DEL_5,confirmDeleteMultipleFileMsgText:AuIt.locale.FILEBR_DEL_6,updateState:function(e){var b=true;if(e.source=="FILEBROWSER"){var c=0,f=0;var a,g=false;Ext.each(e.nodes,function(d){if(d.attributes.isdir){f++}else{if(!a){a=d.parentNode}else{if(d.parentNode!=a){g=true}}c++}if(d.attributes.root){g=true}});this.setDisabled(g||(c>0&&f>0)||f>1)}}};AuIt.Action.FileBrowser.UPLOAD={actionGroup:"FILEBROWSER",disabled:true,itemId:"FILEBROWSER_UPLOAD",iconCls:"auit-filebrowser-icon-upload",tooltip:AuIt.locale.FILEBR_UPLOAD,updateState:function(b){var a=true;if(b.source=="FILEBROWSER"){this.lNode=b.node;this.setDisabled(!b.node||!b.node.attributes.isdir)}},getNodeId:function(){return this.lNode?this.lNode.id:0},uploadFinish:function(){if(this.lNode&&this.lNode.reload){this.lNode.reload()}}};AuIt.Action.FileBrowser.NAVTO={actionGroup:"FILEBROWSER",itemId:"FILEBROWSER_NAVTO"};AuIt.Action.FileBrowser.DIRECTIVE_NEW={actionGroup:"FILEBROWSER",disabled:true,itemId:"FILEBROWSER_DIRECTIVE_NEW",iconCls:"auit-filebrowser-directive-new",tooltip:AuIt.locale.FILEBR_DIRECTIVE_NEW,updateState:function(b){var a=true;if(b.source=="FILEBROWSER"){this.setDisabled(!b.node||!b.node.attributes.isdir||b.node.attributes.dirdirective)}}};AuIt.Action.FileBrowser.DIRECTIVE_EDIT={actionGroup:"FILEBROWSER",disabled:true,itemId:"FILEBROWSER_DIRECTIVE_EDIT",iconCls:"auit-filebrowser-directive-edit",tooltip:AuIt.locale.FILEBR_DIRECTIVE_EDIT,updateState:function(b){var a=true;if(b.source=="FILEBROWSER"){this.setDisabled(!b.node||!b.node.attributes.dirdirective)}}};AuIt.Action.FileBrowser.DIRECTIVE_DEL={actionGroup:"FILEBROWSER",disabled:true,itemId:"FILEBROWSER_DIRECTIVE_DEL",iconCls:"auit-filebrowser-directive-del",tooltip:AuIt.locale.FILEBR_DIRECTIVE_DEL,confirmDeleteTitleText:AuIt.locale.FILEBR_confirmDelete1,confirmDeleteMsgText:AuIt.locale.FILEBR_confirmDelete2,updateState:function(b){var a=true;if(b.source=="FILEBROWSER"){this.setDisabled(!b.node||!b.node.attributes.dirdirective)}}};AuIt.Action.FileBrowser.EDIT={actionGroup:"FILEBROWSER",disabled:true,itemId:"FILEBROWSER_EDIT",iconCls:"auit-filebrowser-edit",tooltip:AuIt.locale.FILEBR_EDIT,updateState:function(b){var a=true;if(b.source=="FILEBROWSER"){this.setDisabled(!b.node||b.node.attributes.isdir)}}};AuIt.Action.FileBrowser.SHOW={actionGroup:"FILEBROWSER",disabled:true,itemId:"FILEBROWSER_SHOW",iconCls:"auit-filebrowser-show",tooltip:AuIt.locale.FILEBR_SHOW,updateState:function(b){var a=true;if(b.source=="FILEBROWSER"){this.setDisabled(!b.node||b.node.attributes.isdir)}}};AuIt.Action.FileBrowser.DOWNLOAD={actionGroup:"FILEBROWSER",disabled:true,itemId:"FILEBROWSER_DOWNLOAD",iconCls:"auit-filebrowser-download",tooltip:AuIt.locale.FILEBR_DOWNLOAD,updateState:function(b){var a=true;if(b.source=="FILEBROWSER"){this.setDisabled(!b.node||b.node.attributes.isdir)}}};AuIt.Action.ToolBar.FileBrowser.MAIN=function(a){return new Ext.Toolbar({items:[{xtype:"buttongroup",title:AuIt.locale.FILEBR_TB_FILE,columns:5,defaults:{scale:"large",iconAlign:"bottom",arrowAlign:"right"},items:[a.getAction("REFRESH","FileBrowser"),a.getAction("NEW","FileBrowser"),a.getAction("RENAME","FileBrowser"),a.getAction("UPLOAD","FileBrowser"),a.getAction("DEL","FileBrowser")]},{xtype:"buttongroup",title:AuIt.locale.FILEBR_TB_Directive,columns:5,defaults:{scale:"large",iconAlign:"bottom",arrowAlign:"right"},items:[a.getAction("DIRECTIVE_NEW","FileBrowser"),a.getAction("DIRECTIVE_EDIT","FileBrowser"),a.getAction("DIRECTIVE_DEL","FileBrowser")]},{xtype:"buttongroup",title:AuIt.locale.FILEBR_TB_Edit,columns:5,defaults:{scale:"large",iconAlign:"bottom",arrowAlign:"right"},items:[a.getAction("EDIT","FileBrowser"),a.getAction("SHOW","FileBrowser"),a.getAction("DOWNLOAD","FileBrowser")]}]})};AuIt.FileBrowserSearch=Ext.extend(Ext.ux.form.SearchField,{border:false,frame:false,setFile:function(a){this.crecord=a;if(a&&a.get){this.setValue(a.get("directive"))}},onTrigger1Click:function(){},onTrigger2Click:function(){var a=this.getRawValue();if(a.length<1){this.onTrigger1Click();return}var b=AuIt.App.getActionMgr().getAction("NAVTO","FileBrowser");b.value=a;b.executeCmd()}});AuIt.FileBrowserTree=Ext.extend(Ext.ux.tree.TreeGrid,{animate:false,cls:"snm-filebrowser",getCNode:function(){var a=this.getSelectionModel().getSelectedNodes();if(a.length==1){return a[0]}return null},initComponent:function(){this.root=new Ext.tree.AsyncTreeNode({text:"Root",expanded:true,id:this.cfg.rootID});this.tbar=AuIt.App.getActionMgr().getToolBar("MAIN","FileBrowser");this.selModel=new Ext.tree.MultiSelectionModel({listeners:{selectionchange:{fn:function(c,a){var b=null;if(a.length==1){b=a[0]}AuIt.App.getActionMgr().updateState({source:"FILEBROWSER",tree_sm:c,node:b,nodes:a})},scope:this}}});this.loader=new Ext.ux.tree.TreeGridLoader({url:AUIT_EDITOR.validate_url,baseParams:{mode:this.initialConfig.cfg.mode},listeners:{beforeload:{fn:function(c,a,b){c.baseParams.isRoot=a.isRoot?1:0;c.baseParams.rootID=a.ownerTree.root.id;c.baseParams.storeID=a.ownerTree.root.attributes.storeID;c.baseParams.action="get-folders";c.baseParams.form_key=FORM_KEY},scope:this}}});AuIt.FileBrowserTree.superclass.initComponent.call(this);this.loader.createNode=function(a){if(!a.uiProvider){if(!a.isdir){a.uiProvider=AuIt.tree.FileNodeUI}else{a.uiProvider=AuIt.tree.DirNodeUI}}if(this.baseAttrs){Ext.applyIf(a,this.baseAttrs)}if(this.applyLoader!==false&&!a.loader){a.loader=this}return !a.isdir?new AuIt.tree.FileNode(a):new AuIt.tree.DirNode(a)}},columns:[{header:AuIt.locale.FILEBR_GC_Name,dataIndex:"text",width:100,tpl:new Ext.XTemplate("")},{header:AuIt.locale.FILEBR_GC_Size,dataIndex:"size",width:100},{header:AuIt.locale.FILEBR_GC_Dimension,width:100,dataIndex:"isize"},{header:AuIt.locale.FILEBR_GC_Date,width:100,dataIndex:"date_modified"}],onResize:function(d,g){AuIt.FileBrowserTree.superclass.onResize.apply(this,arguments);if(Ext.isNumber(d)){var b=5+Ext.num(this.scrollOffset,Ext.getScrollBarWidth());var j=this.getTotalColumnWidth();if(j<d){this.columns[this.columns.length-1].width+=(d-j-b);this.updateColumnWidths()}else{var f=(j-d)+b;for(var e=this.columns.length-1;e>=0;e--){var c=this.columns[e].width;var a=c-f;if(a>=0){this.columns[e].width=a;break}else{this.columns[e].width=0;f=a*=-1}}this.updateColumnWidths()}}},editName:function(d){var c=d.ui.textNode;var a={shadow:false,completeOnEnter:true,cancelOnEsc:true,updateEl:false,ignoreNoChange:false};var b=new Ext.Editor(Ext.apply({alignment:"l-l",listeners:{complete:function(e,h,f){if(h!=f||e.field.updateNode.attributes.isNew){var g=AuIt.App.getActionMgr().getAction("RENAME","FileBrowser");g.updateNode=e.field.updateNode;g.newName=h;g.oldName=f;g.executeCmd()}},canceledit:function(f,g,e){if(f.field.updateNode.attributes.isNew){f.field.updateNode.remove(true)}},show:function(e){this.ownerCt.setDisabled(true)},hide:function(e){this.ownerCt.setDisabled(false)},scope:this},field:{allowBlank:false,xtype:"textfield",width:100,selectOnFocus:true,updateNode:d}},a));b.startEdit(c)}});AuIt.FileBrowserWnd=Ext.extend(AuIt.ModalWindow,{title:AuIt.locale.FILEBR_WND_TITLE,closeAction:"hide",layout:{type:"vbox",align:"stretch"},initComponent:function(){this.childTree=new AuIt.FileBrowserTree({cfg:this.cfg,flex:1});this.childTree.on("dblclick",function(){if(this.onApply()){this.hide()}},this);this.childSearch=new AuIt.FileBrowserSearch();this.items=[this.childSearch,this.childTree];return AuIt.FileBrowserWnd.superclass.initComponent.call(this)},onOK:function(){this.onApply()},onShow:function(){AuIt.App.getActionMgr().on("cmd",this.onCmd,this);AuIt.App.getActionMgr().on("itemchanged",this.onItemChanged,this);AuIt.UploadMgr.addAction(AuIt.App.getActionMgr().getAction("UPLOAD","FileBrowser"));this.isActive=true;AuIt.FileBrowserWnd.superclass.onShow.call(this)},onHide:function(){AuIt.FileBrowserWnd.superclass.onHide.call(this);AuIt.App.getActionMgr().un("cmd",this.onCmd,this);AuIt.App.getActionMgr().un("itemchanged",this.onItemChanged,this);AuIt.UploadMgr.removeAction();this.isActive=false},onItemChanged:function(a){if(this.isActive&&a.source=="FILEBROWSER"&&a.node){if(this.cfg.useRelative){this.childSearch.setValue(a.node.attributes.relative2)}else{this.childSearch.setValue(a.node.attributes.directive)}}},onApply:function(c){if(this.cfg.onApply){var b=[];var a=this.childTree.getSelectionModel().getSelectedNodes();if(a){Ext.each(a,function(d){if(!d.attributes.isdir){b.push({directive:d.attributes.directive,url:d.attributes.url,relative:d.attributes.relative,relative2:d.attributes.relative2})}});if(b.length>0){this.cfg.onApply.call(this,b);return true}}}return false},onCmd:function(f){if(!this.isActive||f.actionGroup!="FILEBROWSER"){return}switch(f.itemId){case"FILEBROWSER_DIRECTIVE_EDIT":var d=this.childTree.getCNode();if(!d){return}var h=new AuIt.Editor.Directive.Wnd({node:d});h.show();h.loadDirective();break;case"FILEBROWSER_DIRECTIVE_NEW":var d=this.childTree.getCNode();if(!d){return}var h=new AuIt.Editor.Directive.Wnd({node:d});h.show();break;case"FILEBROWSER_DIRECTIVE_DEL":var d=this.childTree.getCNode();if(!d){return}Ext.MessageBox.show({title:f.confirmDeleteTitleText,msg:f.confirmDeleteMsgText,buttons:Ext.MessageBox.YESNO,scope:this,icon:Ext.MessageBox.QUESTION,fn:function(j){if(j=="yes"){f.actionMgr.request(f,{directCall:true,url:AUIT_EDITOR.validate_url,node:d,waitMsg:true,waitWnd:this,browserHandler:this,params:{action:"delete-directive",node:d.id,rootID:d.ownerTree.root.id},LoadSuccess:function(k,l){if(k.success){l.node.parentNode.reload()}}})}}});break;case"FILEBROWSER_SHOW":var d=this.childTree.getCNode();if(!d){return}var g=new AuIt.ImageViewer({src:d.attributes.url});g.show();break;case"FILEBROWSER_DOWNLOAD":var d=this.childTree.getCNode();if(!d){return}var a=AUIT_EDITOR.validate_url;a+="form_key/"+FORM_KEY+"/";a+="action/download-file/";a+="nodeid/"+d.id;window.open(a);break;case"FILEBROWSER_EDIT":var d=this.childTree.getCNode();if(!d){return}AuIt.Editor.fileBrowser.showImageEditor(null,{directive:d.attributes.directive,callback:function(m,j){var k=this.childTree.getCNode();if(k){var l=m.node;for(var o in l){if(l.hasOwnProperty(o)){k.attributes[o]=l[o]}}k.refreshView()}},scope:this});break;case"FILEBROWSER_NAVTO":if(f.value){f.actionMgr.request(f,{directCall:true,url:AUIT_EDITOR.validate_url,waitMsg:true,waitWnd:this,browserHandler:this,params:{action:"navto-directive",directive:f.value,useRelative:this.cfg.useRelative?1:0,rootID:this.childTree.root.id,storeID:this.childTree.root.attributes.storeID},scope:this,LoadSuccess:function(j,k){if(j.success){k.browserHandler.childTree.selectPath(j.navto)}}})}break;case"FILEBROWSER_NEW":var d=this.childTree.getCNode();if(!d){return}d.expand(false,true,function(k){var j=k.appendChild(new AuIt.tree.DirNode({text:AuIt.locale.FILEBR_Folder,uiProvider:AuIt.tree.DirNodeUI,iconCls:"bfolder",isdir:true,cls:"x-tree-node-collapsed",isNew:true}));(function(){j.select();this.childTree.editName(j)}).defer(10,this)},this);break;case"FILEBROWSER_REFRESH":var d=this.childTree.getCNode();if(!d){return}if(d&&d.reload){d.reload()}break;case"FILEBROWSER_DEL":var d=null;var b=this.childTree.getSelectionModel().getSelectedNodes();if(b.length>0){d=b[0]}var i=f.confirmDeleteSingleFileTitleText;var c=f.confirmDeleteSingleFileMsgText;if(d.attributes.isdir){i=f.confirmDeleteFolderTitleText;c=f.confirmDeleteFolderMsgText}c=String.format(c,d.text);if(b.length>1){i=f.confirmDeleteMultipleFileTitleText;c=f.confirmDeleteMultipleFileMsgText;c=String.format(c,b.length)}Ext.MessageBox.show({title:i,msg:c,buttons:Ext.MessageBox.YESNO,scope:this,icon:Ext.MessageBox.QUESTION,fn:function(j){if(j=="yes"){var k={action:d.attributes.isdir?"delete-folder":"delete-file",node:d.attributes.isdir?d.id:d.parentNode.id,path:d.getPath("text")};if(!d.attributes.isdir){Ext.each(b,function(l){k["files["+l.id+"]"]=l.attributes.text})}f.actionMgr.request(f,{directCall:true,url:AUIT_EDITOR.validate_url,node:d,nodes:b,waitMsg:true,waitWnd:this,browserHandler:this,params:k,LoadSuccess:function(l,m){if(l.success){m.node.parentNode.select();Ext.each(m.nodes,function(o){o.remove()})}}})}}});break;case"FILEBROWSER_RENAME":if(f.updateNode){var e,d=f.updateNode;f.updateNode=null;if(d.attributes.isdir){if(d.attributes.isNew){d.attributes.text=d.text=f.newName;e={action:"create-folder",node:d.parentNode.id,newName:f.newName,path:d.getPath("text")}}else{e={action:"rename-folder",path:d.parentNode.getPath("text"),node:d.id,newName:f.newName,oldName:f.oldName}}}else{e={action:"rename-file",node:d.parentNode.id,newName:f.newName,oldName:f.oldName}}f.actionMgr.request(f,{directCall:true,url:AUIT_EDITOR.validate_url,node:d,waitMsg:true,waitWnd:this,browserHandler:this,params:e,LoadSuccess:function(j,k){if(j.success){var l=k.node;if(l.attributes.isNew){l.attributes.isNew=null;delete l.attributes.isNew}l.text=l.attributes.text=k.params.newName;l.id=j.id;if(l.attributes.isdir){}else{l.attributes.url=j.url;l.attributes.directive=j.directive}if(l.reload){l.reload()}l.unselect(true);l.select();if(l.ui.textNode.firstChild){l.ui.textNode.firstChild.nodeValue=l.text}else{l.ui.textNode.innerHTML=l.text}}else{var l=k.node;if(l.attributes.isNew){l.remove()}}}})}else{var d=this.childTree.getCNode();if(!d){return}this.childTree.editName(d)}break}}});Ext.namespace("AuIt.Action.ToolBar.ImageViewer","AuIt.Action.ImageViewer");AuIt.Action.ToolBar.ImageViewer.MAIN=function(a){return new Ext.Toolbar({items:[a.getAction("ZOOM","ImageViewer")]})};AuIt.Action.ImageViewer.ZOOM={actionGroup:"IMAGEVIEWER",itemId:"IMAGEVIEWER_ZOOM",tooltip:AuIt.locale.IMG_ZOOM,width:200,xtype:"slider",value:100,increment:10,minValue:10,maxValue:300,canvas:null,plugins:new Ext.ux.SliderTip({getText:function(a){return String.format("<b>{0}%</b>",a.getValue())}}),updateState:function(a){},listeners:{change:function(a,c){var b=this.baseAction;b.viewer.setZoom(c)}}};AuIt.ImageViewer=Ext.extend(AuIt.ModalWindow,{title:AuIt.locale.IMG_WNDT,closeAction:"close",hideAction:"close",modal:true,layout:"fit",initComponent:function(){AuIt.App.getActionMgr().getAction("ZOOM","ImageViewer").viewer=this;this.tbar=AuIt.App.getActionMgr().getToolBar("MAIN","ImageViewer");this.items=this.drawPane=new Ext.Panel({style:"padding:5px",autoScroll:true,cls:"auit-img-editor-canvas",html:'<img src="'+this.src+'" />'});AuIt.ImageViewer.superclass.initComponent.apply(this,arguments)},setZoom:function(b){if(this.drawPane&&this.drawPane.body){var a=Ext.get(this.drawPane.body.dom.firstChild);a.setHeight(b+"%")}},destroy:function(){AuIt.ImageViewer.superclass.destroy.apply(this,arguments)}});AuIt.Editor.fileBrowser=function(){var d,c,b,a;return{showImageEditor:function(f,e){if(!a){a=new AuIt.Image.Editor({id:"AuIt.Image.Editor",onFinish:function(h,i){if(i.original_src!=i.src){i.mode="REPLACEFILE";this.executeCmd(this.canvas.record.data,function(j,k){if(j.success){this.canvas.record.data=j.data;this.canvas.setSrc(j.data.src);if(e.callback){e.callback.call(e.scope||this,j.data,e)}}},this)}}})}a.show();if(e.directive){var g=AuIt.App.getActionMgr().getAction("SETSRC","ImageEditor");g.value=e.directive;g.resetRecord=true;g.executeCmd()}},show:function(g,f){f.rootID=f.rootID||AUIT_EDITOR.file_browser_root.root;if(!d){d=new AuIt.FileBrowserWnd({id:"AuIt.FileBrowserWnd",cfg:{mode:"all",rootID:f.rootID}})}var e=AuIt.App.getActiveEditor();if(d.childTree.root.id!=f.rootID||!e||e.pageData.STORE_ID!=d.childTree.root.attributes.storeID){d.childTree.getSelectionModel().clearSelections();d.childTree.root.id=f.rootID;d.childTree.root.attributes.id=f.rootID;d.childTree.root.attributes.storeID=e?e.pageData.STORE_ID:null;d.childTree.root.reload()}d.show();d.cfg=f;d.field=d.cfg.field||null;if(f.directive){var h=AuIt.App.getActionMgr().getAction("NAVTO","FileBrowser");h.value=f.directive;h.executeCmd()}}}}();AuIt.Editor.Directive.DTD={ROOT:{draggable:false,text:"",tag:"config",attributes:{},childs:["target"]},target:{text:AuIt.locale.DIR_target,cls:"album-node",tag:"target",data:{name:"upload"},childs:["mkdir","copy","transform"]},mkdir:{text:AuIt.locale.DIR_mkdir,cls:"album-node",tag:"mkdir",data:{dir:""},form:{items:{xtype:"textfield",fieldLabel:AuIt.locale.DIR_mkdir_f1,name:"dir",anchor:"100%"}}},copy:{text:AuIt.locale.DIR_copy,cls:"album-node",tag:"copy",data:{todir:""},form:{items:{xtype:"textfield",fieldLabel:AuIt.locale.DIR_copy_f1,name:"todir",anchor:"100%"}}},transform:{text:AuIt.locale.DIR_transform,cls:"album-node",tag:"transform",childs:["resize","rotate","crop","watermark"]},resize:{text:AuIt.locale.DIR_resize,cls:"album-node",tag:"resize",data:{width:"100",height:"100",keepAspectRatio:"true",keepFrame:"false",backgroundColor:"#FFFFFF",keepTransparency:"true",constrainOnly:"true"},form:{items:[{fieldLabel:AuIt.locale.DIR_resize_f1,name:"width",xtype:"spinnerfield",minValue:0,anchor:"100%"},{fieldLabel:AuIt.locale.DIR_resize_f2,name:"height",xtype:"spinnerfield",minValue:0,anchor:"100%"},{fieldLabel:AuIt.locale.DIR_resize_f3,name:"keepAspectRatio",xtype:"combo",triggerAction:"all",store:[["true","True"],["false","False"]],anchor:"100%"},{fieldLabel:AuIt.locale.DIR_resize_f4,name:"keepFrame",xtype:"combo",triggerAction:"all",store:[["true","True"],["false","False"]],anchor:"100%"},{fieldLabel:AuIt.locale.DIR_resize_f5,name:"keepTransparency",xtype:"combo",triggerAction:"all",store:[["true","True"],["false","False"]],anchor:"100%"},{fieldLabel:AuIt.locale.DIR_resize_f6,name:"backgroundColor",xtype:"colorpickerfield",minValue:0,anchor:"100%"}]}},rotate:{text:AuIt.locale.DIR_rotate,cls:"album-node",tag:"rotate",data:{angle:"0"},form:{items:{xtype:"spinnerfield",minValue:0,maxValue:365,fieldLabel:AuIt.locale.DIR_rotate_f1,name:"angle",anchor:"100%"}}},crop:{text:AuIt.locale.DIR_crop,cls:"album-node",tag:"crop",data:{left:0,top:0,right:0,bottom:0},form:{items:[{fieldLabel:AuIt.locale.DIR_crop_f1,name:"left",xtype:"spinnerfield",minValue:0,anchor:"100%",value:"0"},{fieldLabel:AuIt.locale.DIR_crop_f2,name:"top",xtype:"spinnerfield",minValue:0,anchor:"100%",value:"0"},{fieldLabel:AuIt.locale.DIR_crop_f3,name:"right",xtype:"spinnerfield",minValue:0,anchor:"100%",value:"0"},{fieldLabel:AuIt.locale.DIR_crop_f4,name:"bottom",xtype:"spinnerfield",minValue:0,anchor:"100%",value:"0"}]}},watermark:{text:AuIt.locale.DIR_watermark,cls:"album-node",tag:"watermark",data:{image:"",positionX:"10",positionY:"10",watermarkImageOpacity:"50",repeat:"false"},form:{items:[{fieldLabel:AuIt.locale.DIR_watermark_f1,name:"image",xtype:"textfield",anchor:"100%"},{fieldLabel:AuIt.locale.DIR_watermark_f2,name:"positionX",xtype:"spinnerfield",minValue:0,anchor:"100%"},{fieldLabel:AuIt.locale.DIR_watermark_f3,name:"positionY",xtype:"spinnerfield",minValue:0,anchor:"100%"},{fieldLabel:AuIt.locale.DIR_watermark_f4,name:"watermarkImageOpacity",xtype:"spinnerfield",minValue:0,maxValue:100,anchor:"100%"},{fieldLabel:AuIt.locale.DIR_watermark_f5,name:"repeat",xtype:"combo",triggerAction:"all",store:[["true","True"],["false","False"]],anchor:"100%"}]}}};AuIt.Editor.Directive.Tree=Ext.extend(Ext.tree.TreePanel,{border:false,frame:false,rootVisible:false,autoScroll:true,enableDD:true,animate:false,initComponent:function(){this.root=this.attributes.handler.getNode("ROOT");AuIt.Editor.Directive.Tree.superclass.initComponent.apply(this,arguments);this.getSelectionModel().on({selectionchange:function(b,a){if(a){this.attributes.handler.setDataView(a)}},scope:this});this.on("nodedragover",function(d){var c=null;if(d.point=="append"){c=d.target.attributes.childs}else{if(d.point=="above"||d.point=="below"){c=d.target.parentNode.attributes.childs}}if(c){var a=d.dropNode.attributes.dtdname;for(var b=0;b<c.length;b++){if(c[b]==a){return}}}return false},this)}});AuIt.Editor.Directive.Wnd=Ext.extend(AuIt.ModalWindow,{id:"AuIt.Editor.Directive",title:AuIt.locale.DIR_WNDT,width:400,height:250,minWidth:300,minHeight:250,layout:"border",mode:"new",onOK:function(){this.saveDirective(this.buildXml(this.tree.root));return false},buildXml:function(a){this.formCnt.items.each(function(c){if(c.node){Ext.apply(c.node.attributes.data,c.getForm().getFieldValues())}});var b={};if(a.attributes.data){b["@attributes"]=a.attributes.data}a.eachChild(function(c){b[c.attributes.tag]=this.buildXml(c)},this);return b},saveDirective:function(a){AuIt.App.getActionMgr().request({itemId:"SAVE_DIRECTIVE",handler:this},{directCall:true,url:AUIT_EDITOR.validate_url,waitMsg:true,waitWnd:this,browserHandler:this,params:{action:"save-directive",node:this.node.id,rootID:this.node.ownerTree.root.id,mode:this.mode,data:a},LoadSuccess:function(b,c){if(b.success){if(this.handler.mode=="new"){this.handler.node.parentNode.reload()}this.handler.close()}}})},loadDirective:function(){AuIt.App.getActionMgr().request({itemId:"LOAD_DIRECTIVE",handler:this},{directCall:true,url:AUIT_EDITOR.validate_url,waitMsg:true,waitWnd:this,browserHandler:this,params:{action:"load-directive",node:this.node.id,rootID:this.node.ownerTree.root.id},scope:this,LoadSuccess:function(a,b){if(a.success){this.handler.createTree(a.json,this.handler.tree.root)}}})},createTree:function(a,b){this.mode="replace";var d,c;for(d in a){if(a.hasOwnProperty(d)&&d!="@attributes"){c=this.getNode(d,a[d]["@attributes"]);if(c){b.appendChild(c);this.createTree(a[d],c)}}}},setDataView:function(d){var a=this.formCnt.removeAll(false);Ext.each(a,function(e){if(e.node){Ext.apply(e.node.attributes.data,e.getForm().getFieldValues())}e.destroy()});var c=d.attributes.form||{};c=Ext.ux.clone(c);if(d.attributes.dtdname){var b=this.getMenu(d.attributes.dtdname,d);if(b.length>0){c.tbar=[{text:AuIt.locale.DIR_ADD,menu:b}]}}c.node=d;c.border=false;c.frame=false;c.bodyStyle="padding:10px;";c=new Ext.form.FormPanel(c);c.getForm().loadRecord(d.attributes);this.formCnt.add(c);this.formCnt.doLayout()},getNode:function(a,c){var b=AuIt.Editor.Directive.DTD[a];if(!b){return null}b=Ext.ux.clone(b);var d={dtdname:a};Ext.apply(d,b);if(c){Ext.apply(d.data,c)}return new Ext.tree.TreeNode(d)},getMenu:function(b,c){var a=[];Ext.each(AuIt.Editor.Directive.DTD[b].childs,function(f){var d={},e=Ext.ux.clone(AuIt.Editor.Directive.DTD[f]);e.node=c;e.dtdname=f;d.text=e.text;d.cls=e.cls;d.attributes=e;d.handler=function(i){var g=i.initialConfig.attributes;var h=g.node.appendChild(this.getNode(g.dtdname));g.node.expand();g.node.ownerTree.getSelectionModel().select(h)};d.scope=this;a.push(d)},this);return a},initComponent:function(){this.tree=new AuIt.Editor.Directive.Tree({region:"west",width:150,maxWidth:250,split:true,floatable:true,attributes:{handler:this}});this.formCnt=new Ext.Panel({border:false,frame:false,autoScroll:true,region:"center",layout:"fit",attributes:{handler:this}});this.items=[this.tree,this.formCnt];this.tbar=[{text:AuIt.locale.DIR_ADD,menu:this.getMenu("ROOT",this.tree.root)},{text:AuIt.locale.DIR_DELCMD,handler:function(){var a=this.tree.getSelectionModel().getSelectedNode();if(a){a.remove()}},scope:this}];AuIt.Editor.Directive.Wnd.superclass.initComponent.apply(this,arguments)}});